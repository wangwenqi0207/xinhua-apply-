<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0,maximum-scale=1, minimum-scale=1"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>填写申请信息</title>
    <link rel="icon" href="./images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="./css/reset.css" />
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="./css/index.css" />
    <link rel="stylesheet" type="text/css" href="./css/access_apply.css" />
    <script
      src="./script/thirdplugins/jquery-3.3.1.min.js"
      type="text/javascript"
    ></script>
    <style>
      .h1,
      .h2,
      .h3,
      h1,
      h2,
      h3 {
        margin: 0;
      }
      .cityleft {
        float: left;
        padding-right: 10px;
      }
      .save_bar {
        margin-top: 0;
        border-top: none;
      }
      .dfinput {
        width: 185px;
      }
      .box_page {
        padding: 30px 0;
      }
      .box_page .img_box {
        padding-bottom: 0;
      }
      .box_page .pgb_tt {
        border-top: #d9d9d9 1px solid;
        padding: 0 24px;
      }
      .box_page .img_list {
        padding-left: 24px;
        padding-bottom: 10px;
        width: 1050px;
        margin-bottom: 0px;
      }
      .pgb_tt {
        border: #d9d9d9 1px solid;
        border-top: none;
        line-height: 44px;
        padding: 0 40px;
        font-weight: normal;
        font-size: 14px;
        color: #333;
        position: relative;
      }
      .pgb_tt .up_btn {
        margin: 0 20px;
      }
      .pgb_tt b {
        font-weight: normal;
        font-size: 14px;
        padding-right: 5px;
      }
      .pgb_tt i {
        width: 24px;
        height: 24px;
        display: inline-block;
        background: url(./images/edit_ico.gif) center no-repeat;
        border: #cccccc 1px solid;
        border-radius: 3px;
        position: absolute;
        right: 15px;
        top: 9px;
        cursor: pointer;
      }
      .pgb_tt i.current {
        background: url(./images/retract_ico.gif) center no-repeat;
      }
      .c_fa6 {
        color: #fa6730;
      }
      .img_box {
        border: #d9d9d9 1px solid;
        overflow: hidden;
        border-top: none;
        padding: 20px 0;
      }
      .file input,
      .up_btn input,
      .up_img input {
        position: absolute;
        font-size: 500px;
        right: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        width: 80px;
        height: 80px;
      }
      .up_btn,
      .up_btn:hover {
        height: 30px;
        line-height: 30px;
        vertical-align: middle;
        color: #fff;
        position: relative;
        top: -2px;
      }
      .up_img {
        width: 80px;
        height: 80px;
        display: block;
        background: url(./images/up_img.gif) no-repeat;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
      }
      #result {
        float: left;
      }
      #result li {
        float: left;
        position: relative;
      }
      #result img {
        display: inline-block;
        width: 80px;
        height: 80px;
        margin-left: 10px;
        margin-bottom: 10px;
      }
      .del_btn {
        width: 20px;
        height: 18px;
        display: block;
        position: absolute;
        right: 0;
        bottom: 10px;
        background: url(./images/del.png) no-repeat;
        cursor: pointer;
        z-index: 9;
      }
    </style>
  </head>
  <body>
    <div class="topcontainer"></div>
    <div class="bodycontent main-body">
      <div class="step_wrap">
        <img src="./images/step3.png" alt="" />
      </div>
      <div class="container-fluid">
        <div class="row">
          <div class="formbody ">
            <form
              action=""
              method="post"
              class="form-inline"
              id="applyForm"
              enctype="multipart/form-data"
            >
              <h2 class="h2_tt">3.填写申请信息</h2>
              <div class="box_page">
                <h3 class="pgb_tt">
                  相关资料图片上传<b class="c_fa6" id="countUpload">0/20</b>张
                  <i class="current"></i>
                </h3>
                <div class="img_box">
                  <ul class="img_list" id="paperImgs" style="width:100%;overflow: hidden;">
                    <li>
                      <div class="file_box" style="float: left">
                        <a href="javascript:;" class="up_img">
                          <input
                            id="imgFile"
                            accept="image/gif,image/jpeg,image/png"
                            type="file"
                          />
                        </a>
                      </div>
                    </li>
                    <ul id="result" style="width:90%"></ul>
                  </ul>
                </div>
              </div>
              <div class="">
                <ul class="forminfo formifo2">
                  <li>
                    <label>参保人姓名<b>*</b></label
                    ><input
                      id="fullName"
                      name="fullName"
                      type="text"
                      class="dfinput"
                      value=""
                      readonly="readonly"
                      style="color: gray"
                    />
                  </li>
                  <li>
                    <label>性别<b>*</b></label>
                    <div class="vocation">
                      <select id="sex" name="sex" class="select2">
                        <option value="">请选择</option>
                        <option value="M">男</option>
                        <option value="F">女</option>
                      </select>
                    </div>
                  </li>
                  <li>
                    <label>身份证号<b>*</b></label
                    ><input
                      id="insIdCard"
                      name="insIdCard"
                      type="text"
                      class="dfinput"
                      value=""
                      readonly="readonly"
                      style="color: gray"
                    />
                  </li>
                  <li>
                    <label>年龄<b>*</b></label
                    ><input
                      id="age"
                      name="age"
                      type="text"
                      class="dfinput"
                      value=""
                      readonly="readonly"
                      style="color: gray"
                    />
                  </li>
                  <li>
                    <label>社保卡号</label
                    ><input
                      id="medicalIinsuranceId"
                      name="medicalIinsuranceId"
                      maxlength="18"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                  <li>
                    <label>联系电话/手机</label
                    ><input
                      id="insUserPhone"
                      name="insUserPhone"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                  <li class="li_long" id="regionEdit">
                    <label>参保人区域<b>*</b></label>
                    <div class="vocation">
                      <select
                        id="province"
                        class="select2"
                        name="appointedProvinceId"
                      >
                      </select>
                    </div>
                    <div class="vocation">
                      <select id="city" class="select2" name="appointedCityId">
                      </select>
                    </div>
                    <div class="vocation">
                      <select
                        id="district"
                        name="appointedRegionId"
                        class="select2"
                      >
                      </select>
                    </div>
                    <!-- <div class="vocation">
                        <select
                          id="street"
                          name="appointedStreetId"
                          class="select2"
                        >
                        </select>
                      </div> -->
                  </li>
                  <li class="li_long">
                    <label>参保人详细地址<b>*</b></label>
                    <input
                      id="residentialRegionId"
                      name="residentialRegionId"
                      type="hidden"
                      class="dfinput"
                    />
                    <!-- 	<input id="residentialRegionIdOld" name="residentialRegionIdOld" type="hidden" class="dfinput"  /> -->
                    <input
                      id="appointedAddress"
                      name="appointedAddress"
                      type="text"
                      class="dfinput"
                      value=""
                      style="width: 300px"
                    />
                  </li>
                </ul>
                <ul class="forminfo formifo2">
                  <li>
                    <label>联系人姓名<b>*</b></label
                    ><input
                      id="contactName"
                      name="contactName"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                  <li>
                    <label>联系人性别<b>*</b></label>
                    <div class="vocation">
                      <select id="contactSex" name="contactSex" class="select2">
                        <option value="">请选择</option>
                        <option value="M">男</option>
                        <option value="F">女</option>
                      </select>
                    </div>
                  </li>
                  <li>
                    <label>联系人身份证<b>*</b></label
                    ><input
                      id="contactIdcard"
                      name="contactIdcard"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                  <li>
                    <label>联系人电话<b>*</b></label
                    ><input
                      id="contactPhone"
                      name="contactPhone"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                  <li>
                    <label>与参保人关系<b>*</b></label>
                    <div class="vocation">
                      <select
                        class="select2"
                        id="relationshipInsUser"
                        name="relationshipInsUser"
                      >
                        <option value="0" selected="selected">自己</option>
                        <option value="1">子女</option>
                        <option value="2">父母</option>
                        <option value="3">配偶</option>
                        <option value="4">兄弟姐妹</option>
                        <option value="5">朋友</option>
                        <option value="6">其它</option>
                      </select>
                    </div>
                  </li>


                  <li>
                    <label>家庭医生姓名</label
                    ><input
                      id="familyDoctorName"
                      name="familyDoctorName"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                  <li>
                    <label>家庭医生联系方式</label
                    ><input
                      id="familyDoctorPhone"
                      name="familyDoctorPhone"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                  <li>
                    <label>家庭医生单位</label
                    ><input
                      id="familyDoctorCompany"
                      name="familyDoctorCompany"
                      type="text"
                      class="dfinput"
                      value=""
                    />
                  </li>
                </ul>
              </div>
              <div class="save_bar ">
                <input id="update" name="update" type="hidden" value="0" />
                <a href="javascript:history.back();" class="btn">上一步</a>
                <input
                  name="nextStep"
                  type="button"
                  class="btn"
                  value="提交申请"
                  onclick="submitStep()"
                />
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="footercontainer"></div>
    <script
      src="./script/thirdplugins/jquery.cookie.js"
      type="text/javascript"
    ></script>
    <script
      src="./script/thirdplugins/bootstrap.min.js"
      type="text/javascript"
    ></script>
    <script src="./script/js/index.js" type="text/javascript"></script>
    <script>
      $(function() {
        $(".pgb_tt i").click(function() {
          $(this).toggleClass("current");
          $(this)
            .parent("h3")
            .next(".img_box")
            .toggle();
        });
      });
      function toPrev() {
        window.location.href = "./access_apply_two.html?update=y";
      }

      var isSubmitting = false;
      // var queryUrl = "http://192.168.1.16:9008/insurance-intact-web/";
      function submitStep() {
        if (isSubmitting) {
          tip("正在提交中，请勿重复提交");
          return;
        }
        isSubmitting = true;
        var appointedTime1 = $("#appointedTime1").val();
        var appointedTime2 = $("#appointedTime2").val();
        var contactPhone = $("#contactPhone").val();
        var contactName = $("#contactName").val();
        var contactIdcard = $("#contactIdcard").val();
        var contactSex = $("#contactSex").val();
        var appointedAddress = $("#appointedAddress").val();

        if (!appointedAddress) {
          tip("参保人详细地址必须填写");
          isSubmitting = false;
          return;
        }

        if (!contactName) {
          tip("联系人姓名必须填写");
          isSubmitting = false;
          return;
        }
        if (!contactSex) {
          tip("联系人性别必填");
          isSubmitting = false;
          return;
        }
        if (!contactIdcard) {
          tip("联系人身份证号必须填写");
          isSubmitting = false;
          return;
        }

        if (!contactPhone) {
          tip("联系人电话必须填写");
          isSubmitting = false;
          return;
        }


        var appTime = appointedTime1 + " " + appointedTime2 + ":00";
        $("#appointedTime").val(appTime);

        var provinceText = $("#province")
          .find("option:selected")
          .text();
        var provinceVal = $("#province")
          .find("option:selected")
          .val();
        var cityText = $("#city")
          .find("option:selected")
          .text();
        var cityVal = $("#city")
          .find("option:selected")
          .val();
        var districtText = $("#district")
          .find("option:selected")
          .text();
        var districtVal = $("#district")
          .find("option:selected")
          .val();

        var regionStr =
          "provinceText=" +
          provinceText +
          "&provinceVal=" +
          provinceVal +
          "&cityText=" +
          cityText +
          "&cityVal=" +
          cityVal +
          "&districtText=" +
          districtText +
          "&districtVal=" +
          districtVal;
        var arry = $("#applyForm").serializeArray();
        var obj = {};
        for (var i = 0; i < arry.length; i++) {
          obj[arry[i].name] = arry[i].value;
        }
        var uuid = $.cookie("_PRE_UUID_");
        obj.provinceText = provinceText;
        obj.provinceVal = provinceVal;
        obj.cityText = cityText;
        obj.cityVal = cityVal;
        obj.districtText = districtText;
        obj.districtVal = districtVal;
        var allImgLi = $("#result").find("li");
        var picAry = [];
        for (var i = 0; i < allImgLi.length; i++) {
          var imgLi = allImgLi[i].firstChild;
          if (imgLi.nodeName == "INPUT" || imgLi.tagName == "INPUT") {
            var imgLiSrc = imgLi.value;
            var picUrl = imgLiSrc;
            picAry.push(picUrl);
          }
        }
        obj.paperPics = picAry;
        if($.cookie("access_apply_fullname") &&$.cookie("access_apply_idcard")){
        $.ajax({
          type: "POST",
          url: queryUrl+"/auth/applyInfo?preUuid="+uuid,
          contentType: "application/json; charset=utf-8",
          data: JSON.stringify(obj),
          dataType: "json",
          xhrFields: {
            withCredentials: true
          },
          crossDomain: true,
          success: function(res) {
            if (res.resultCode == "000000") {
              $.cookie('isReAccess',null,{expires:-1,path:'/'});
              $.cookie('oldOrderNo',null,{expires:-1,path:'/'});
              $.cookie('_PRE_UUID_',null,{expires:-1,path:'/'});
              window.location.href = "./access_apply_four.html?oderNo="+res.data;
            } else {
              tip(res.resultMsg);
              isSubmitting=false;
            }
          },
          error: function() {
            tip("请求失败，服务出错！");
          }
        });
      }else{
        tip('违规操作');
        setTimeout(function(){
          window.location.href="./access_apply_one.html"
        },2500);
      }
      }
    </script>
    <script>
      window.onload = function() {
        loadRegion(337, 485, 1721); //选择浙江-金华-义乌
        $(".topnavbarright li:nth-child(2)")
          .addClass("current")
          .siblings()
          .removeClass("current");
          if (
              $.cookie("access_apply_fullname") &&
              $.cookie("access_apply_idcard")
            ) {
              getNameAge(
                $.cookie("access_apply_fullname"),
                $.cookie("access_apply_idcard")
              );
            } else {
              tip("未获取到姓名和身份证号");
              setTimeout(function() {
                window.location.href = "./access_apply_one.html";
              }, 3000);
            }

      };
      function loadRegion(provinceV, cityV, districtV) {
          $.get(queryUrl+"/get_provinces", function getProvinces(list) {
            var html = "";
            for (var i = 0; i < list.length; i++) {
              html +=
                '<option value="' +
                list[i].regionId +
                '">' +
                list[i].regionName +
                "</option>";
            }
            $("#province").html(html);
            if (provinceV != null && list.length >= 1) {
              $("#province").val(provinceV + "");
              $("#province").change();
            }
          });

          $("#province").change(function() {
            $("#district").html("");
            if (!$("#province").val()) {
              return;
            }
            $.get(
              queryUrl+"/get_regions?p=1&parentId="+$("#province").val(),
              function rg(list) {
                $("#city").html("");
                var html = "";
                for (var i = 0; i < list.length; i++) {
                  html +=
                    "<option value='" +
                    list[i].regionId +
                    "'>" +
                    list[i].regionName +
                    "</option>";
                }
                $("#city").html(html);
                $("#city").val(list[0].regionId);
                if (cityV != null && list.length >= 1) {
                  $("#city").val(cityV + "");
                  $("#city").change();
                }
              }
            );
          });
          $("#city").change(function() {
            if (!$("#city").val()) {
              return;
            }
            $.get(
              queryUrl+"/get_regions?c=2&parentId="+$("#city").val(),
              function rg(list) {
                $("#district").html("");
                var html = "";
                for (var i = 0; i < list.length; i++) {
                  html +=
                    "<option value='" +
                    list[i].regionId +
                    "'>" +
                    list[i].regionName +
                    "</option>";
                }
                $("#district").html(html);
                if (districtV != null && list.length >= 1) {
                  $("#district").val(districtV + "");
                  $("#district").change();
                }
              }
            );
          });
          // $("#district").change(function() {
          //   if (!$("#district").val()) {
          //     return;
          //   }
          //   $.get(
          //     `${queryUrl}/get_regions?c=2&parentId=${$("#district").val()}`,
          //     function rg(list) {
          //       $("#street").html("");
          //       var html = "";
          //       for (var i = 0; i < list.length; i++) {
          //         html +=
          //           "<option value='" +
          //           list[i].regionId +
          //           "'>" +
          //           list[i].regionName +
          //           "</option>";
          //       }
          //       $("#street").html(html);
          //       if (streetV != null && list.length >= 1) {
          //         $("#street").val(streetV + "");
          //         $("#street").change();
          //       }
          //     }
          //   );
          // });
      }

      // 从缓存中读取姓名和身份证号
      function getNameAge(fullName, idCard) {
        var birthYear = idCard.slice(6, 10);
        var currentDate = new Date();
        var currentYear = currentDate.getFullYear();
        var age = +currentYear - +birthYear;
        $("#fullName").attr("value", fullName);
        $("#age").attr("value", age);
        $("#insIdCard").attr("value", idCard);
        if (
          idCard.charAt(idCard.length - 2) % 2 == 1
        ) {
          document.getElementById("sex")[1].selected = true;
        } else {
          document.getElementById("sex")[2].selected = true;
        }
      }

      // if (
      //   $.cookie("access_apply_fullname") &&
      //   $.cookie("access_apply_idcard")
      // ) {
      //   getNameAge(
      //     $.cookie("access_apply_fullname"),
      //     $.cookie("access_apply_idcard")
      //   );
      // } else {
      //   tip("未获取到姓名和身份证号");
      //   setTimeout(function() {
      //     window.location.href = "./access_apply_one.html";
      //   }, 3000);
      // }
    </script>
    <script type="text/javascript">
      // var globalUrl = "http://192.168.1.187:4280/";
      var imgMax = 20;
      var imgCount = 0;
      function countUploads(type) {
        if (type == 1 && imgCount < imgMax) {
          imgCount++;
        } else if (type == -1 && imgCount > 0) {
          imgCount--;
        } else {
          return false;
        }
        $("#countUpload").text(imgCount + "/" + imgMax);
        return true;
      }
      function delParent(obj) {
        if (window.confirm("确定删除该图片？")) {
          $(obj)
            .parent()
            .remove();
          countUploads(-1);
        } else {
        }
      }
      function ProcessFile(e) {
        if (imgCount >= imgMax) {
          tip("最多只能上传" + imgMax + "张图片");
          return;
        }
        var file = document.getElementById("imgFile").files[0];
        if (file) {
          var reader = new FileReader();
          reader.onload = function(event) {
            var txt = event.target.result;
            var img = document.createElement("img");
            img.src = txt;
          };
        }
        reader.readAsDataURL(file);
        var formData = new FormData();
        formData.append("imgFile", file);
        $.ajax({
          type: "POST",
          url: queryUrl+"/upload_paper_img",
          data: formData,
          cache: false,
          processData: false,
          contentType: false,
          xhrFields: {
            withCredentials: true
          },
          crossDomain: true,
          error: function() {
            tip("服务器连接失败");
          },
          success: function(res) {
            if (res.errorCode == 0) {
              $("#result").prepend(
                "<li><input value="+res.file+" type='hidden'/><img src="+globalUrl+"/"+res.file+" /><i class='del_btn' onclick=delParent(this)></i></li>"
              );
              countUploads(1);
            }
            if(res.errorCode=='11001'){
              tip(res.errorMsg);
            }
          }
        });
      }
      function contentLoaded() {
        document
          .getElementById("imgFile")
          .addEventListener("change", ProcessFile, false);
      }
      window.addEventListener("DOMContentLoaded", contentLoaded, false);
    </script>
  </body>
</html>
